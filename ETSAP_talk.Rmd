---
title: "Analysing DemoS runs using VedaR"
author: ""
date: "30/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, 
                      warning = F,
                      message = F)
```


# {.tabset}

```{r}
#Load packages
library(vedar)
library(tidyverse) #library for data processing and plots
library(plotly) #library for interactive plots
library(igraph) #library for working with network (graph) objects
library(DT) #library for javascript table display
library(kableExtra) #library for html table display
```

```{r variables}
#define variables
filename_base_001 <- "./data/demos_001"
filename_base_007 <- "./data/demos_007"
all_costs_001_file <- "./data/all_costs_001.csv"

```

## Importing the data

* R is efficient at handling data in "long" format: each column is a variable and repeated measures are in separate rows (Excel tables are often use "wide" format)
* The `prep_data()` function imports and combines the data contained in the vd, vds, and vde file. This generates a single long R dataframe (tibble). All strings are in lower case, missing data is replaced with NA (or "annual" for timeslice).
* Here, we import all the data from demos_001 to create a dataframe object `demos_001`, and display the data in an interactive table `demos_001`

```{r import_data}

#import the demos_001 data into a tibble
demos_001 <- prep_data(filename_base = filename_base_001)

#display the first 20 rows of the dataframe
datatable(demos_001)



```

## Comparing the data to veda tables

* We can compare results produced by VedaR to those produced from tables generated by the Veda graphical-user interface. 

* Here, we compare the output of the "All costs" Veda table to comparable output from VedaR.


```{r compare_to_veda}
# load results tables that were generated by Veda DemoS_001 example

all_costs_001 <- read.csv(all_costs_001_file)

all_costs_001 %>%
  select(Attribute, 
         Commodity, 
         Process, 
         Period, 
         Region,
         Pv) %>%
  arrange(Attribute, Process, Period) %>%
  knitr::kable(caption = "Veda csv output")


demos_001 %>% 
  #select rows in which attribute contains the string "cost_" 
  # and process contains "coa
  filter(str_detect(attribute, "cost_"), 
         str_detect(process, "coa")) %>%
  select(attribute, 
         commodity, 
         process, 
         period, 
         region,
         pv) %>%
  arrange(attribute, process, period)  %>%
  knitr::kable(caption = "VedaR data")
  
  
```  

## Visually presenting data with R

* A powerful and widely-used data visualisation package in R is ggplot
* Here, we create a plot to display compare costs over years broken down by process, from the demos_001 data

```{r}
data_to_plot <- demos_001

data_to_plot  %>%
   #select the cost attributes
  filter(str_detect(attribute, "(cost_)")) %>%
  # period will be plotted on x-axis, so replace period == NA with "none" for display
  mutate(period = replace_na(period, "None")) %>%
  # create the plot
  ggplot(aes(x = as.character(attribute), 
             y = pv, 
             # the colour is specified by the attribute column
             fill = process)) + 
  geom_col() +
  #axis labels
  xlab("") +
  ylab("Cumulative period cost") + 
  #remove legend title
  scale_fill_discrete("") +
  #rotate x-label
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  # group by process in separate facets
  facet_grid(rows = vars(period),
             cols = vars(region),
             scales = "free") 



```


* We can create a plot for a different dataset by simply changing the data that is passed to the plot.
* Here, we plot the demos_007 data by changing the object data_to_plot. All other lines remaing the same

```{r, out.width='1000px', dpi = 200}
demos_007 <- prep_data(filename_base = filename_base_007)
data_to_plot <- demos_007  

data_to_plot %>%
  #select the cost attributes
  filter(str_detect(attribute, "(cost_)")) %>%
  # period will be plotted on x-axis, so replace period == NA with "none" for display
  mutate(period = replace_na(period, "None")) %>%
  # create the plot
  ggplot(aes(x = as.character(attribute), 
             y = pv, 
             # the colour is specified by the attribute column
             fill = process)) + 
  geom_col() +
  #axis labels
  xlab("") +
  ylab("Cumulative period cost") + 
  #remove legend title
  scale_fill_discrete("") +
  #rotate x-label
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  # group by process in separate facets
  facet_grid(rows = vars(period),
             cols = vars(region),
             scales = "free") 


```